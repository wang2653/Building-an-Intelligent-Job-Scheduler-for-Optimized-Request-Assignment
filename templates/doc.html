<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Doctor-Patient Management</title>
  <link rel="stylesheet" type="text/css" href="../static/style.css">
  <style>
    /* Reusable class to hide an element */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>

  <div class="doctor-container">
    <!-- Left Sidebar -->
    <div class="sidebar">
      <!-- Top section: user photo, name, etc. -->
      <div class="login-status">
        <img src="../static/momo1.jpeg" alt="User Photo" class="user-photo" />
        <p class="user-name">Admin</p>
        <p class="user-email">admin@example.com</p>
      </div>
    
      <!-- Navigation / panel selection in the middle -->
      <nav class="nav-links">
        <h3>Control Panel</h3>
        <a href="#" id="doctor-link">Staff</a>
        <a href="#" id="patient-link">Patient</a>
      </nav>
    
      <!-- Doctor Panel (hidden by default) -->
      <div id="doctor-panel" class="panel doctor-panel hidden">
        <form method="post">
          <label>Staff Name</label>
          <input type="text" name="name" required>
          <label>Position</label>
          <input type="text" name="availability">
          <div class="button-group">
            <button>Add/Edit Staff</button>
            <button>Remove Staff</button>
          </div>
        </form>
      </div>
    
      <!-- Patient Panel (hidden by default) -->
      <div id="patient-panel" class="panel patient-panel hidden">
        <form method="post">
          <label>Patient ID</label>
          <input type="text" name="id" required placeholder="e.g. 17">
          <label>Arrivial Time</label>
          <input type="text" name="arrival_time" placeholder="e.g. 22">
          <label>Acuity Level</label>
          <input type="text" name="acuity_level" placeholder="e.g. 1">
          <label>Treatment Plan</label>
          <input type="text" name="treatment_plan" placeholder="e.g. 1, 2, 3, 8">
          <label>Treatment Time</label>
          <input type="text" name="treatment_time" placeholder="e.g. 1, 1, 8, 22">
          <div class="button-group">
            <button type="submit" name="action" value="add">Add/Edit Patient</button>
            <button type="submit" name="action" value="remove">Remove Patient</button>
          </div>
        </form>
      </div>
    
      <!-- Logout link at the bottom -->
      <div class="logout">
        <a href="/" class="logout-link">Logout</a>
      </div>
    </div>

    <script>
      // Sidebar panel toggling using the .hidden class.
      const doctorLink = document.getElementById('doctor-link');
      const patientLink = document.getElementById('patient-link');
      const doctorPanel = document.getElementById('doctor-panel');
      const patientPanel = document.getElementById('patient-panel');
    
      doctorLink.addEventListener('click', function(e) {
        e.preventDefault();        
        doctorPanel.classList.remove('hidden');  
        patientPanel.classList.add('hidden');  
      });
    
      patientLink.addEventListener('click', function(e) {
        e.preventDefault();
        patientPanel.classList.remove('hidden'); 
        doctorPanel.classList.add('hidden');
      });
    </script>
    
    <!-- Main Content Area -->
    <div class="main">
      <!-- Header with buttons -->
      <div class="header">
        <input type="text" placeholder="Search..." class="search-input" id="searchBar" />
        <button id="searchButton">Search</button>
        <button id="doctorBtn">Staff</button>
        <button id="patientBtn">Patient</button>
        <div id="currentTimeDisplay" class="currentTimeDisplay">
          Current Time: ...
        </div>
      </div>
  
      <!-- Content Area with Two Containers -->
      <div class="content" id="contentArea">
        <!-- Doctor Cards Container (fixed cards) -->
        <div id="doctor-cards-container">
          <!-- 8 Doctors -->
          <div class="card" id="resource-0">
            <img src="../static/doc1.jpeg" alt="Doctor 1">
            <h3>Alexander Morgan</h3>
            <h3>Position: Doctor</h3>
            <p id="status-0">Status: ???</p>
            <p id="task-0">Task: ???</p>
          </div>
          <div class="card" id="resource-1">
            <img src="../static/doc9.jpg" alt="Doctor 2">
            <h3>Amelia Brooks</h3>
            <h3>Position: Doctor</h3>
            <p id="status-1">Status: ???</p>
            <p id="task-1">Task: ???</p>
          </div>
          <div class="card" id="resource-2">
            <img src="../static/doc10.jpg" alt="Doctor 3">
            <h3>Charlotte Hayes</h3>
            <h3>Position: Doctor</h3>
            <p id="status-2">Status: ???</p>
            <p id="task-2">Task: ???</p>
          </div>
          <div class="card" id="resource-3">
            <img src="../static/doc4.jpeg" alt="Doctor 4">
            <h3>Ryan Blake</h3>
            <h3>Position: Doctor</h3>
            <p id="status-3">Status: ???</p>
            <p id="task-3">Task: ???</p>
          </div>
          <div class="card" id="resource-4">
            <img src="../static/doc5.jpeg" alt="Doctor 5">
            <h3>Thomas Maxwell</h3>
            <h3>Position: Doctor</h3>
            <p id="status-4">Status: ???</p>
            <p id="task-4">Task: ???</p>
          </div>
          <div class="card" id="resource-5">
            <img src="../static/doc6.jpeg" alt="Doctor 6">
            <h3>William Dalton</h3>
            <h3>Position: Doctor</h3>
            <p id="status-5">Status: ???</p>
            <p id="task-5">Task: ???</p>
          </div>
          <div class="card" id="resource-6">
            <img src="../static/doc12.jpg" alt="Doctor 7">
            <h3>Grace Ellis</h3>
            <h3>Position: Doctor</h3>
            <p id="status-6">Status: ???</p>
            <p id="task-6">Task: ???</p>
          </div>
          <div class="card" id="resource-7">
            <img src="../static/doc13.jpg" alt="Doctor 8">
            <h3>Quinn Taylor</h3>
            <h3>Position: Doctor</h3>
            <p id="status-7">Status: ???</p>
            <p id="task-7">Task: ???</p>
          </div>

          <!-- 7 Nurses -->
          <div class="card" id="resource-8">
            <img src="../static/nurse1.jpg" alt="Nurse 1">
            <h3>Fiona Summers</h3>
            <h3>Position: Nurse</h3>
            <p id="status-8">Status: ???</p>
            <p id="task-8">Task: ???</p>
          </div>
          <div class="card" id="resource-9">
            <img src="../static/nurse2.jpg" alt="Nurse 2">
            <h3>Daisy Monroe</h3>
            <h3>Position: Nurse</h3>
            <p id="status-9">Status: ???</p>
            <p id="task-9">Task: ???</p>
          </div>
          <div class="card" id="resource-10">
            <img src="../static/nurse3.jpg" alt="Nurse 3">
            <h3>Bella Crawford</h3>
            <h3>Position: Nurse</h3>
            <p id="status-10">Status: ???</p>
            <p id="task-10">Task: ???</p>
          </div>
          <div class="card" id="resource-11">
            <img src="../static/nurse4.jpg" alt="Nurse 4">
            <h3>Samuel Turner</h3>
            <h3>Position: Nurse</h3>
            <p id="status-11">Status: ???</p>
            <p id="task-11">Task: ???</p>
          </div>
          <div class="card" id="resource-12">
            <img src="../static/nurse5.jpg" alt="Nurse 5">
            <h3>Hannah Parker</h3>
            <h3>Position: Nurse</h3>
            <p id="status-12">Status: ???</p>
            <p id="task-12">Task: ???</p>
          </div>
          <div class="card" id="resource-13">
            <img src="../static/nurse6.jpg" alt="Nurse 6">
            <h3>Lily Bennett</h3>
            <h3>Position: Nurse</h3>
            <p id="status-13">Status: ???</p>
            <p id="task-13">Task: ???</p>
          </div>
          <div class="card" id="resource-14">
            <img src="../static/nurse7.jpg" alt="Nurse 7">
            <h3>Mia Hart</h3>
            <h3>Position: Nurse</h3>
            <p id="status-14">Status: ???</p>
            <p id="task-14">Task: ???</p>
          </div>

          <!-- 2 X-Ray -->
          <div class="card" id="resource-15">
            <img src="../static/X-RAY1.jpg" alt="X-Ray 1">
            <h3>Patrick Walsh</h3>
            <h3>Position: X-Ray Technician</h3>
            <p id="status-15">Status: ???</p>
            <p id="task-15">Task: ???</p>
          </div>
          <div class="card" id="resource-16">
            <img src="../static/X-RAY2.jpg" alt="X-Ray 2">
            <h3>Oliver Dean</h3>
            <h3>Position: X-Ray Technician</h3>
            <p id="status-16">Status: ???</p>
            <p id="task-16">Task: ???</p>
          </div>

          <!-- 2 CT -->
          <div class="card" id="resource-17">
            <img src="../static/ct1.jpg" alt="CT 1">
            <h3>Jack Sullivan</h3>
            <h3>Position: CT Technician</h3>
            <p id="status-17">Status: ???</p>
            <p id="task-17">Task: ???</p>
          </div>
          <div class="card" id="resource-18">
            <img src="../static/ct2.jpg" alt="CT 2">
            <h3>Katherine Shaw</h3>
            <h3>Position: CT Technician</h3>
            <p id="status-18">Status: ???</p>
            <p id="task-18">Task: ???</p>
          </div>
        </div>

        <!-- Patient Cards Container (empty initially) -->
        <div id="patient-cards-container" class="hidden">
          <!-- Patient cards will be dynamically created here -->
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPT: Toggling Views and Auto-Updates -->
  <script>
    // Get DOM elements for view toggling
    const doctorBtn = document.getElementById('doctorBtn');
    const patientBtn = document.getElementById('patientBtn');
    const doctorCardsContainer = document.getElementById('doctor-cards-container');
    const patientCardsContainer = document.getElementById('patient-cards-container');

    let currentView = 'doctor';
    let doctorInterval = null;
    let patientInterval = null;
    let patientCards = [];
    const maxPatients = 200;

    // Update fixed doctor/resource cards from /get_doctors
    function updateMedicalResources() {
      if (currentView !== 'doctor') return;
      fetch('/get_doctors')
        .then(res => res.json())
        .then(data => {
          // data.resources is an array of 19 objects {status, task}
          for (let i = 0; i < data.resources.length; i++) {
            const resStatus = data.resources[i].status;
            const resTask = data.resources[i].task;
            const statusEl = document.getElementById(`status-${i}`);
            const taskEl = document.getElementById(`task-${i}`);
            if (parseInt(resStatus) === 0) {
              statusEl.innerText = "Status: Available";
              taskEl.innerText = "Task: 0";
            } else {
              statusEl.innerText = `Status: Occupied (Patient ${resStatus})`;
              taskEl.innerText = `Task: ${resTask}`;
            }
          }
        });
    }

    // Create patient cards inside the patient container
    function createPatientCards() {
      patientCardsContainer.innerHTML = ''; // clear container
      patientCards = [];
      for (let i = 0; i < maxPatients; i++) {
        let card = document.createElement('div');
        card.className = 'card patient-card';
        card.style.display = 'none';
        card.innerHTML = `
          <img src="https://via.placeholder.com/80" alt="Patient Photo">
          <h3 id="patient-id-${i}">Patient</h3>
          <p id="acuity-${i}">Acuity Level: </p>
          <p id="waiting-${i}">Waiting Time: </p>
          <p id="treatment-${i}">Current Treatment: </p>
          <p id="remaining-${i}">Remaining Time: </p>
          <p id="patient-status-${i}">Status: </p>
        `;
        patientCardsContainer.appendChild(card);
        patientCards.push(card);
      }
    }

    // Update patient cards using /get_patients
    function updatePatients() {
      if (currentView !== 'patient') return;
      fetch('/get_patients')
        .then(response => response.json())
        .then(newPatients => {
          for (let i = 0; i < maxPatients; i++) {
            if (i < newPatients.length) {
              document.getElementById(`patient-id-${i}`).innerText = `Patient ${newPatients[i].patient_id}`;
              document.getElementById(`acuity-${i}`).innerText = `Acuity Level: ${newPatients[i].acuity_level}`;
              document.getElementById(`waiting-${i}`).innerText = `Waiting Time: ${newPatients[i].waiting_time}`;
              document.getElementById(`treatment-${i}`).innerText = `Current Treatment: ${newPatients[i].current_treatment}`;
              document.getElementById(`remaining-${i}`).innerText = `Remaining Time: ${newPatients[i].remaining_time}`;
              let statusText = newPatients[i].status == 1 ? "In Treatment" : "Waiting";
              const statusElement = document.getElementById(`patient-status-${i}`);
              if (statusElement) {
                statusElement.innerText = `Status: ${statusText}`;
              }


              patientCards[i].style.display = 'block';
            } else {
              patientCards[i].style.display = 'none';
            }
          }
        });
    }

    // Toggle to doctor view
    doctorBtn.addEventListener('click', () => {
      currentView = 'doctor';
      doctorCardsContainer.classList.remove('hidden');
      patientCardsContainer.classList.add('hidden');
      if (patientInterval) {
        clearInterval(patientInterval);
        patientInterval = null;
      }
      updateMedicalResources();
      if (!doctorInterval) {
        doctorInterval = setInterval(updateMedicalResources, 1000);
      }
    });

    // Toggle to patient view
    patientBtn.addEventListener('click', () => {
      currentView = 'patient';
      doctorCardsContainer.classList.add('hidden');
      patientCardsContainer.classList.remove('hidden');
      if (doctorInterval) {
        clearInterval(doctorInterval);
        doctorInterval = null;
      }
      createPatientCards();
      setTimeout(updatePatients, 10);
      if (!patientInterval) {
        patientInterval = setInterval(updatePatients, 1000);
      }
    });

    // On page load, default to doctor view
    doctorCardsContainer.classList.remove('hidden');
    patientCardsContainer.classList.add('hidden');
    updateMedicalResources();
    doctorInterval = setInterval(updateMedicalResources, 1000);

    // Get current time
    const currentTimeEl = document.getElementById('currentTimeDisplay');
    function updateCurrentTime() {
      fetch('/get_current_time')
        .then(response => response.json())
        .then(data => {
          currentTimeEl.innerText = 'Current Time: ' + data.current_time;
        })
        .catch(err => console.error(err));
    }
    updateCurrentTime();
    setInterval(updateCurrentTime, 100);

    // Search Function
    const searchButton = document.getElementById('searchButton');
    const searchBar = document.getElementById('searchBar');

    searchButton.addEventListener('click', () => {
      // 1. Grab the user’s search input
      const queryId = searchBar.value.trim();
      if (!queryId) {
        return; // If empty, do nothing or optionally show a message
      }

      // 2. Call our new /search_patients endpoint
      fetch(`/search_patients?patient_id=${encodeURIComponent(queryId)}`)
        .then((res) => res.json())
        .then((data) => {
          // data is an array of patient objects returned from search.csv

          // 3. Switch our main view to "patient" so we can display the results
          currentView = 'patient';
          doctorCardsContainer.classList.add('hidden');
          patientCardsContainer.classList.remove('hidden');

          // 4. Show only the filtered patient(s).
          //    Easiest is to dynamically rebuild the patient container with the data.
          patientCardsContainer.innerHTML = ''; // clear out any existing cards

          // If no data returned, handle that case
          if (data.length === 0) {
            patientCardsContainer.innerHTML = '<p>No matching patient found.</p>';
            return;
          }

          // 5. Create a card for each row in "data"
          data.forEach((patient) => {
            // Build a card with the same structure as your existing patient cards
            const card = document.createElement('div');
            card.className = 'card patient-card';
            card.innerHTML = `
              <img src="https://via.placeholder.com/80" alt="Patient Photo">
              <h3>Patient ${patient.patient_id}</h3>
              <p>Acuity Level: ${patient.acuity_level}</p>
              <p>Waiting Time: ${patient.waiting_time}</p>
              <p>Current Treatment: ${patient.current_treatment}</p>
              <p>Remaining Time: ${patient.remaining_time}</p>
              <p>Status: ${patient.status == 1 ? 'In Treatment' : 'Waiting'}</p>
            `;
            patientCardsContainer.appendChild(card);
          });
        })
        .catch((err) => {
          console.error('Search error:', err);
        });
    });
  </script>

</body>
</html>
